!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).MiniVue=t()}(this,(function(){"use strict";const e=[];class t{constructor(){this.subs=[]}notify(){this.subs.forEach(e=>e.update())}depend(){const t=e.length?e[e.length-1]:null;t&&!t.deps.includes(this)&&(t.deps.push(this),this.subs.push(t))}}class n{constructor(e,n,s){this.vm=e,this.deps=[],this.dep=new t,this.getter=n,this.__value=null,this.dirty=!0,this.cb=s,this.cb&&this.getVal()}get value(){return this.dep.depend(),this.dirty&&this.getVal(),this.__value}getVal(){e.push(this),this.__value=this.getter.call(this.vm),e.pop(),this.dirty=!1}update(){if(this.cb){const e=this.value;this.getVal(),this.cb.call(this.vm,this.__value,e)}else this.dirty=!0;this.dep.notify()}}class s{constructor(e){this.value=e,Object.defineProperty(e,"__ob__",{value:this}),Array.isArray(e)?this.observeArray(e):this.observeObj(e)}observeObj(e){Object.keys(e).forEach(n=>{const s=e[n];r(s);const o=function(e,n,s){const r=new t,o=Object.getOwnPropertyDescriptor(e,n);let i=(o.get||(()=>e[n])).call(s),l=o.set||(e=>i=e);return Object.defineProperty(e,n,{get:()=>(r.depend(),i),set(t){t!==i&&(l.call(s||e,t),r.notify())},configurable:!0,enumerable:!0}),r}(e,n);Array.isArray(s)&&["push","pop","splice","shift"].forEach(e=>{s[e]=function(...t){const n=Array.prototype[e].apply(s,t);return o.notify(),n}})})}observeArray(e){e.forEach(e=>r(e))}}function r(e){if(e&&"object"==typeof e)return Object.prototype.hasOwnProperty.call(e,"__ob__")?e.__ob__:new s(e)}const o=[];function i(e){!function e(t){if(!t||!Array.isArray(t)&&"object"!=typeof t||o.includes(t))return;Array.isArray(t)?t.forEach(t=>e(t)):Object.values(t).forEach(t=>e(t))}(e),o.length=0}const l=new Proxy(class{constructor(e,t){this.source=e,this.info=t}get value(){return void 0!==this.info?this.source[this.info]:this.source}set value(e){void 0!==this.info?this.source[this.info]=e:this.source=e}},{apply:(e,t,n)=>new e(...n)});function c(e,t){const n=e.props,s=t.props,r={};let o=!0;return Object.keys(n).forEach(e=>{s[e]!==n[e]&&(o=!1,r[e]=[n[e],s[e]])}),Object.keys(s).forEach(e=>{Object.prototype.hasOwnProperty.call(n,e)||(o=!1,r[e]=[null,s[e]])}),o?null:r}function h(e,t){return function e(t,n,s=0,r={}){if(0===t.length)return r;{let o=[],i=[];const l=Math.max(t.length,n.length);for(let e=0;e<l;e+=1){const l=t[e],h=n[e];if(l&&h){const t=s+e+1;if(o=o.concat(l.children||[]),i=i.concat(h.children||[]),l.isText)h.isText?l.text!==h.text&&(r[t]={type:"TEXT",text:h.text}):r[t]={type:"REPLACE",node:h};else if(h.tagName!==l.tagName)r[t]={type:"REPLACE",node:h};else{const e=c(l,h);e&&(r[t]={type:"PROPS",props:e})}}else if(l){const t=s+n.length+1;r[t]?r[t].moves.push({index:e,type:0,node:l}):r[t]={type:"REORDER",moves:[{index:e,type:0,node:l}]}}else{const n=s+t.length;r[n]?("REORDER"!==r[n].type&&(r[n].appendType="REORDER",r[n].moves=r[n].moves||[]),r[n].moves.push({index:e,type:1,node:h})):r[n]={type:"REORDER",moves:[{index:e,type:1,node:h}]}}}return e(o,i,s+t.length,r)}}([e],[t],-1)}function a(e,t){if(t){const n=Object.keys(t);n.length>0&&(!function(e,t=0){const n=[];n.push(l(e));for(let e=0;e<n.length;e+=1){const t=n[e].value;"string"!=typeof t&&t.children&&t.children.length>0&&t.children.forEach((e,s)=>{const r=s;n.push(l(t.children,r))})}e.indexs=n}(e),n.forEach(n=>{const s=t[n];if("REPLACE"===s.type){const t=e.indexs[n].value.$el;t&&t.parentNode.replaceChild(s.node.render(),t),e.indexs[n].value=s.node}else if("PROPS"===s.type)!function(e,t){if(("string"==typeof e||e.isText)&&console.warn("no way here: set props for a textnode"),t){const n=Object.keys(t);n.length>0&&n.forEach(n=>{e.props[n]=t[n][1],e.setAttr(n,t[n][1],t[n][0])})}}(e.indexs[n].value,s.props);else if("TEXT"===s.type){const t=e.indexs[n].value,r=t.$el;r&&(t.text=s.text,r.nodeValue=s.text)}else"REORDER"===s.type&&(s.moves.filter(e=>0===e.type).sort((e,t)=>e.index<t.index?1:-1).forEach(t=>{const{source:s}=e.indexs[n];t.node&&t.node.$el&&t.node.$el.parentNode&&t.node.$el.parentNode.removeChild(t.node.$el),s.splice(s.findIndex(e=>e===t.node),1)}),s.moves.filter(e=>1===e.type).sort((e,t)=>e.index>t.index?1:-1).forEach(t=>{const{source:s,value:r}=e.indexs[n];s&&s.length>0&&s[0].$el.parentNode.appendChild(t.node.render()),e.indexs[n].source.push(t.node)}));"REORDER"===s.appendType&&(s.moves.filter(e=>0===e.type).sort((e,t)=>e.index<t.index?1:-1).forEach(t=>{const{source:s}=e.indexs[n];t.node&&t.node.$el&&t.node.$el.parentNode&&t.node.$el.parentNode.removeChild(t.node.$el),s.splice(s.findIndex(e=>e===t.node),1)}),s.moves.filter(e=>1===e.type).sort((e,t)=>e.index>t.index?1:-1).forEach(t=>{const{source:s,value:r}=e.indexs[n];s&&s.length>0&&s[0].$el.parentNode.appendChild(t.node.render()),e.indexs[n].source.push(t.node)}))}))}}class u{constructor(e,t,n){this.tagName=e,this.props=t||{},this.children=n||[],this.key=t?t.key:void 0,this.isText=!1,this.text="";let s=0;this.children.forEach((e,t)=>{if(e instanceof u)s+=e.count;else{const n=new u;n.isText=!0,n.text=e,this.children[t]=n}s+=1}),this.count=s}render(){if(this.isText){const e=document.createTextNode(this.text);return this.$el=e,e}const e=document.createElement(this.tagName);this.$el=e;const{props:t}=this;return Object.keys(t).forEach(e=>{this.setAttr(e,t[e])}),this.children.forEach(t=>{const n=t&&t.render();n&&e.appendChild(n)}),e}setAttr(e,t,n){if("function"==typeof t&&e.startsWith("@")){const s=e.slice(1);n&&this.$el.removeEventListener(s,n),this.$el.addEventListener(s,t)}else"value"===e?this.$el.value=t:this.$el.setAttribute(e,t)}}const d=new Proxy(u,{apply:(e,t,n)=>new e(...n)});function p(e,t){return e[t]}const f=[];function y(e){return e.startsWith("v-bind:")||e.startsWith(":")||e.startsWith("v-show")}f.push((function(e,t,n){if("v-bind"===t){const t=p(this,n);return t&&"object"==typeof t&&Object.assign(e,t),!0}if(t.startsWith("v-bind:")||t.startsWith(":")){const[,s]=t.split(":");return e[s]=p(this,n),!0}return!1})),f.push((function(e,t,n){if(t.startsWith("v-on:")||t.startsWith("@")){const[,s]=t.split(/[:@]/);return e["@"+s]=this[n],!0}return!1})),f.push((function(e,t,n){if("v-show"===t){return p(this,n)||(e.style?e.style+=";display:none;":e.style=";display:none;"),!0}return!1})),f.push((function(e,t,n){return e[t]=n,!0}));class v{constructor(e,t={}){this.isRoot=!1,this.name=e,this.attrs=t,this.children=[]}addAttr(e,t){this.attrs[e]=t}render(e){if("v-if"in this.attrs){if(!p(e,this.attrs["v-if"]))return null}if("root"===this.name)return this.children.length?this.children[0].render(e):null;if("text"===this.name)return function(e,t){let n=t,s=t.match(/{{\w+}}/g);return s=[...new Set(s)],s.forEach(t=>{const s=t.substr(2,t.length-4),r=p(e,s);n=n.replace(new RegExp(t.replace(/\{/,"\\{"),"g"),r)}),n}(e,this.attrs.content);const t={};return Object.keys(this.attrs).filter(e=>!["v-for","v-if"].includes(e)).sort((e,t)=>{const n=y(e)?0:1;return(y(t)?0:1)-n}).forEach(n=>{const s=this.attrs[n];for(const r of f)if(r.call(e,t,n,s))break}),d(this.name,t,this.children.map(t=>t.render(e)).filter(e=>e))}}function m(e,t,n){const s=t.substr(e).match(n);return s?[s[0],e+s[0].length]:null}function g(e,t,n=null){if(null===n||0===n.length)return[t.substring(e),t.length];let s=e;for(;s<t.length&&!n.includes(t[s]);)s+=1;return s===t.length&&(s=-1),-1===s?[t.substring(e),t.length]:[t.substr(e,s-e),s]}function b(e){try{return function(e){const t=[],n=new v("root",{});if(t.push(n),!e)return n.children;const s=e.trim();let r=0,o=0,i=n;const l={name:"",value:"",separator:"",slash:0};for(;;){if(0===o)if("<"===s[r]&&"/"===s[r+1]){const[,e]=m(r+2,s,/^[^>]+/);r=e+1,t.pop(),i=t[t.length-1]}else if("<"===s[r]){const[e,n]=g(r+1,s,[" ",">"]),l=new v(e);i.children.push(l),t.push(l),i=l,o=" "===s[n]?1:0,r=n+1}else{const[e,t]=g(r,s,["<"]);i.children.push(new v("text",{content:e})),r=t}else if(1===o)if(" "===s[r])r+=1;else if("/"===s[r]&&">"===s[r+1])r+=2,t.pop(),i=t[t.length-1],o=0;else if(">"===s[r])r+=1,o=0;else{const e=m(r,s,/^[^=]+/),[t,n]=e;l.name=t,r=n+1,o=11}else if(11===o){if(!["'",'"'].includes(s[r]))throw new Error("value seperator not valid in "+r);l.separator=s[r],o=111,r+=1}else 111===o&&("\\"===s[r]?(l.slash=1-l.slash,r+=1,l.value+=s[r]):s[r]===l.separator?l.slash?(l.slash=0,r+=1,l.value+=s[r]):(i.addAttr(l.name,l.value),l.name="",l.value="",l.slash=0,l.separator="",o=1,r+=1):(l.value+=s[r],r+=1));if(r>=s.length){if(0!==o)throw new Error("not normal exit state",o);break}}return n}(e)}catch(e){return console.log("err when compile template",e),null}}function E(e,t,n){Object.defineProperty(e,t,{configurable:!0,enumerable:!0,...n})}function x(e,t){Object.keys(e).forEach(n=>{E(t,n,{set:function(t){e[n]=t},get:function(){return e[n]}})})}return function(e){const t=this;let s=e.data||{};s="function"==typeof e.data?e.data.call(t):s,r(s),t.$data=s,x(s,t);const o=e.computed||{},l={};Object.keys(o).forEach(e=>{const s=o[e],r=new n(t,s);E(l,e,{get:function(){return r.value},set:function(e){console.warn("cannot set computed value with",e)}})}),x(l,t);const c=e.methods||{};Object.keys(c).forEach(e=>{const n=c[e];t[e]=(...e)=>n.apply(t,e)});const u=e.watch||{};Object.keys(u).forEach(e=>{const s=u[e];new n(t,()=>{let n=t;return e.split(".").forEach(e=>n=n[e]),n},(...e)=>s.apply(t,e))}),e.el&&("string"==typeof e.el?t.$el=document.querySelector(e.el):t.$el=e.el);const d=b(e.template||"");t.$render=()=>d.render(t),t.render=()=>{if(!t.$render)return null;if(t.$vdom=t.$render.call(t),t.$preVdom){const e=h(t.$preVdom,this.$vdom);a(t.$preVdom,e)}else t.$el.firstElementChild&&t.$el.firstElementChild.remove(),t.$el.appendChild(t.$vdom.render()),t.$preVdom=t.$vdom},t.render(),t.renderWatcher=new n(t,(function(){i(s),i(l)}),t.render)}}));

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).MiniVue=t()}(this,(function(){"use strict";const e=[];class t{constructor(){this.subs=[]}notify(){this.subs.forEach(e=>e.update())}depend(){const t=e.length?e[e.length-1]:null;t&&!t.deps.includes(this)&&(t.deps.push(this),this.subs.push(t))}}class n{constructor(e,n,r){this.vm=e,this.deps=[],this.dep=new t,this.getter=n,this.__value=null,this.dirty=!0,this.cb=r,this.cb&&this.getVal()}get value(){return this.dep.depend(),this.dirty&&this.getVal(),this.__value}getVal(){e.push(this),this.__value=this.getter.call(this.vm),e.pop(),this.dirty=!1}update(){if(this.cb){const e=this.value;this.getVal(),this.cb.call(this.vm,this.__value,e)}else this.dirty=!0;this.dep.notify()}}class r{constructor(e){this.value=e,Object.defineProperty(e,"__ob__",{value:this}),Array.isArray(e)?this.observeArray(e):this.observeObj(e)}observeObj(e){Object.keys(e).forEach(n=>{const r=e[n];s(r);const o=function(e,n,r){const s=new t,o=Object.getOwnPropertyDescriptor(e,n);let i=(o.get||(()=>e[n])).call(r);const l=o.set||(e=>{i=e});return Object.defineProperty(e,n,{get:()=>(s.depend(),i),set(t){t!==i&&(l.call(r||e,t),s.notify())},configurable:!0,enumerable:!0}),s}(e,n);Array.isArray(r)&&["push","pop","splice","shift"].forEach(e=>{r[e]=function(...t){const n=Array.prototype[e].apply(r,t);return o.notify(),n}})})}observeArray(e){e.forEach(e=>s(e))}}function s(e){return e&&"object"==typeof e?Object.prototype.hasOwnProperty.call(e,"__ob__")?e.__ob__:new r(e):null}const o=[];function i(e){!function e(t){!t||!Array.isArray(t)&&"object"!=typeof t||o.includes(t)||(o.push(t),Array.isArray(t)?t.forEach(t=>e(t)):Object.values(t).forEach(t=>e(t)))}(e),o.length=0}class l{constructor(e,t,n){this.isComponent=!1,this.parentNode=null,this.tagName=e,this.props=t||{},this.children=n||[],this.key=t?t.key:void 0,this.isText=!1,this.text="",this.children.forEach((e,t)=>{if(e instanceof l)e.parentNode=this;else{const n=new l;n.isText=!0,n.text=e,n.parentNode=this,this.children[t]=n}})}render(){if(this.isText){const e=document.createTextNode(this.text);return this.$el=e,e}const e=document.createElement(this.tagName);this.$el=e;const{props:t}=this;return Object.keys(t).forEach(e=>{this.setAttr(e,t[e])}),this.children.forEach(t=>{const n=t&&t.render();n&&e.appendChild(n)}),e}setAttr(e,t,n){if("function"==typeof t&&e.startsWith("@")){const r=e.slice(1);n&&this.$el.removeEventListener(r,n),this.$el.addEventListener(r,t)}else"value"===e?this.$el.value=t:t?this.$el.setAttribute(e,t):this.$el.removeAttribute(e)}appendChild(e){this.children.push(e),e.parentNode=this}removeChild(e){const t=this.children.indexOf(e);-1!==t?this.children.splice(t,1):console.log("_Element removeChild failed")}replaceChild(e,t){const n=this.children.indexOf(e);-1!==n?(this.children[n]=t,t.parentNode=this):console.log("_Element replaceChild failed")}removeSelf(){this.parentNode&&this.parentNode.removeChild(this)}replaceSelf(e){this.parentNode&&this.parentNode.replaceChild(this,e)}}const c=new Proxy(l,{apply:(e,t,n)=>new e(...n)});function a(e,t,n=[]){if(e.isText&&t.isText)e.text!==t.text&&n.push({type:"TEXT",node:e,text:t.text});else if(e.tagName===t.tagName){const r=function(e,t){const n=e.props,r=t.props,s={};let o=!0;return Object.keys(n).forEach(e=>{r[e]!==n[e]&&(o=!1,s[e]=[n[e],r[e]])}),Object.keys(r).forEach(e=>{Object.prototype.hasOwnProperty.call(n,e)||(o=!1,s[e]=[null,r[e]])}),o?null:s}(e,t);r&&n.push({node:e,type:"PROPS",props:r}),function(e,t,n,r=[]){const s=Math.max(t.length,n.length);for(let o=0;o<s;o+=1){const s=o<t.length?t[o]:null,i=o<n.length?n[o]:null;s&&i?a(s,i,r):s?r.push({type:"REMOVE",parentNode:e,node:s}):r.push({type:"ADD",parentNode:e,node:i})}}(e,e.children,t.children,n)}else n.push({type:"REPLACE",node:e,newNode:t});return n}function h(e){e&&e.length>0&&e.forEach(e=>{const{type:t,node:n,parentNode:r,newNode:s,text:o}=e;"REPLACE"===t?(n.replaceSelf(s),n.$el.parentNode.replaceChild(s.render(),n.$el)):"PROPS"===t?function(e){const{node:t}=e,{props:n}=e;if(("string"==typeof t||t.isText)&&console.warn("no way here: set props for a textnode"),n){const e=Object.keys(n);e.length>0&&e.forEach(e=>{t.props[e]=n[e][1],t.setAttr(e,n[e][1],n[e][0])})}}(e):"TEXT"===t?(n.text=o,n.$el.nodeValue=o):"ADD"===t?(r.appendChild(n),r.$el.appendChild(n.render())):"REMOVE"===t&&(n.removeSelf(),n.$el.remove())})}function u(e,t,n={}){return void 0!==n[t]?n[t]:e[t]}const p=[];function d(e){return e.startsWith("v-bind:")||e.startsWith(":")||e.startsWith("v-show")}p.push((function(e,t,n,r={}){const s=r&&r.scope||{};if(e.bindGetters||Object.defineProperty(e,"bindGetters",{enumerable:!1,value:{}}),"v-bind"===t){const t=u(this,n,s);return t&&"object"==typeof t&&(Object.assign(e,t),Object.keys(t).forEach(t=>{Object.defineProperty(e.bindGetters,t,{configurable:!0,enumerable:!0,get:()=>u(this,n,s)[t]})})),!0}if(t.startsWith("v-bind:")||t.startsWith(":")){const[,r]=t.split(":");return e[r]=u(this,n,s),Object.defineProperty(e.bindGetters,r,{configurable:!0,enumerable:!0,get:()=>u(this,n,s)}),!0}return!1})),p.push((function(e,t,n){if(t.startsWith("v-on:")||t.startsWith("@")){const[,r]=t.split(/[:@]/);return e["@"+r]=this[n],!0}return!1})),p.push((function(e,t,n){if("v-show"===t){return u(this,n)||(e.style?e.style+=";display:none;":e.style=";display:none;"),!0}return!1})),p.push((function(e,t,n){return e[t]=n,!0}));class f{constructor(e,t={}){this.isRoot=!1,this.name=e,this.attrs=t,this.children=[]}addAttr(e,t){this.attrs[e]=t}render(e,t){if("v-for"in this.attrs)return function(e,t,n={}){const r=t.trim(),s=r.indexOf(" in "),o=r.substring(0,s).trim();let i=[];o.startsWith("(")?i=o.substr(1,o.length-2).split(",").map(e=>e.trim()):i.push(o);let l=u(e,r.substring(s+4),n)||[],c=!1;return"number"==typeof l?l=Array(l).fill(" ").map((e,t)=>t):"string"==typeof l&&(l=Array(l.length).fill(" ").map((e,t)=>l[t])),Array.isArray(l)?l=l.map((e,t)=>({item:e,index:t,key:t})):"object"==typeof l&&(l=Object.keys(l).map((e,t)=>({item:l[e],index:t,key:e})),c=!0),l.map(({item:e,index:t,key:r})=>{const s={...n};return i.forEach((n,o)=>{switch(o){case 0:s[n]=e;break;case 1:s[n]=c?r:t;break;case 2:c&&(s[n]=t)}}),s})}(e,this.attrs["v-for"],t).map(t=>this.doRender(e,t));if("v-if"in this.attrs){if(!u(e,this.attrs["v-if"]))return null}return this.doRender(e,t)}doRender(e,t={}){if("root"===this.name)return this.children.length?this.children[0].render(e):null;if("text"===this.name)return function(e,t,n={}){let r=t,s=t.match(/{{\w+}}/g);return s=[...new Set(s)],s.forEach(t=>{const s=t.substr(2,t.length-4),o=u(e,s,n);r=r.replace(new RegExp(t.replace(/\{/,"\\{"),"g"),o)}),r}(e,this.attrs.content,t);const n={};Object.keys(this.attrs).filter(e=>!["v-for","v-if"].includes(e)).sort((e,t)=>{const n=d(e)?0:1;return(d(t)?0:1)-n}).forEach(r=>{const s=this.attrs[r];for(const o of p)if(o.call(e,n,r,s,{scope:t}))break});const r=e.component(this.name);if(r){console.log("createComp new one");return r({$parentVm:e,$attrs:n.bindGetters}).$render()}return c(this.name,n,this.children.map(n=>n.render(e,t)).filter(e=>e).flat())}}function m(e,t,n){const r=t.substr(e).match(n);return r?[r[0],e+r[0].length]:null}function y(e,t,n=null){if(null===n||0===n.length)return[t.substring(e),t.length];let r=e;for(;r<t.length&&!n.includes(t[r]);)r+=1;return r===t.length&&(r=-1),-1===r?[t.substring(e),t.length]:[t.substr(e,r-e),r]}function b(e){try{return function(e){const t=[],n=new f("root",{});if(t.push(n),!e)return n.children;const r=e.trim();let s=0,o=0,i=n;const l={name:"",value:"",separator:"",slash:0};for(;;){if(0===o)if("<"===r[s]&&"/"===r[s+1]){const[,e]=m(s+2,r,/^[^>]+/);s=e+1,t.pop(),i=t[t.length-1]}else if("<"===r[s]){const[e,n]=y(s+1,r,[" ",">"]),l=new f(e);i.children.push(l),t.push(l),i=l,o=" "===r[n]?1:0,s=n+1}else{const[e,t]=y(s,r,["<"]);i.children.push(new f("text",{content:e})),s=t}else if(1===o)if(" "===r[s])s+=1;else if("/"===r[s]&&">"===r[s+1])s+=2,t.pop(),i=t[t.length-1],o=0;else if(">"===r[s])s+=1,o=0;else{const e=m(s,r,/^[^=]+/),[t,n]=e;l.name=t,s=n+1,o=11}else if(11===o){if(!["'",'"'].includes(r[s]))throw new Error("value seperator not valid in "+s);l.separator=r[s],o=111,s+=1}else 111===o&&("\\"===r[s]?(l.slash=1-l.slash,s+=1,l.value+=r[s]):r[s]===l.separator?l.slash?(l.slash=0,s+=1,l.value+=r[s]):(i.addAttr(l.name,l.value),l.name="",l.value="",l.slash=0,l.separator="",o=1,s+=1):(l.value+=r[s],s+=1));if(s>=r.length){if(0!==o)throw new Error("not normal exit state",o);break}}return n}(e)}catch(e){return console.log("err when compile template",e),null}}function g(e){return Array(e.length).fill("").map((t,n)=>{const r=e[n];return r.charCodeAt()>=65&&r.charCodeAt()<=90?`${0!==n?"-":""}${r.toLowerCase()}`:r}).join("")}var v={create:function(e,t){const n={};return function(r,s){const o=g(r);if(!s)return t&&t(o)||n[o];n[o]=function(t){const n={...s,...t};return new e(n)},n[o].options=s}},normalizeName:g};function E(e,t,n){Object.defineProperty(e,t,{configurable:!0,enumerable:!0,...n})}function $(e,t){Object.keys(e).forEach(n=>{E(t,n,{set:function(t){e[n]=t},get:function(){return e[n]}})})}function w(e){const t=this;t.$options=e,e.el&&("string"==typeof e.el?t.$el=document.querySelector(e.el):t.$el=e.el),t.isRoot=!!e.el,t.component=t.isRoot?w.component:v.create(w,w.component);const r=e.components||{};if(Object.keys(r).forEach(e=>t.component(e,r[e])),e.$parentVm){t.$parentVm=e.$parentVm;let r=e.props||{};const s={};Array.isArray(r)&&r.forEach(e=>{s[e]={}}),r={},Object.keys(s).forEach(s=>{const o=new n(t,()=>e.$attrs[s]);E(r,s,{get:function(){return o.value},set:function(e){console.warn("cannot set computed value with",e)}})}),$(r,t)}let o=e.data||{};o="function"==typeof e.data?e.data.call(t):o,s(o),t.$data=o,$(o,t);const l=e.computed||{},c={};Object.keys(l).forEach(e=>{const r=l[e],s=new n(t,r);E(c,e,{get:function(){return s.value},set:function(e){console.warn("cannot set computed value with",e)}})}),$(c,t);const u=e.methods||{};Object.keys(u).forEach(e=>{const n=u[e];t[e]=(...e)=>n.apply(t,e)});const p=e.watch||{};t.$watchers=[],Object.keys(p).forEach(e=>{const r=p[e],s=new n(t,()=>{let n=t;return e.split(".").forEach(e=>{n=n[e]}),n},(...e)=>r.apply(t,e));t.$watchers.push(s)}),t.$elTree=b(e.template||""),t.$elTree.isComponent=!!t.$parentVm,t.$render=()=>t.$elTree.render(t),t.render=()=>{if(t.$render)if(t.$vdom=t.$render.call(t),t.$preVdom){h(a(t.$preVdom,this.$vdom))}else t.isRoot&&(t.$el.firstElementChild&&t.$el.firstElementChild.remove(),t.$el.appendChild(t.$vdom.render())),t.$preVdom=t.$vdom},t.$el&&(t.renderWatcher=new n(t,()=>{i(o),i(c)},t.render),t.render())}return w.component=v.create(w),w}));

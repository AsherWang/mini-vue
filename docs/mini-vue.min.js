!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).MiniVue=t()}(this,(function(){"use strict";const e=[];class t{constructor(){this.subs=[]}notify(){this.subs.forEach(e=>e.update())}depend(){const t=e.length?e[e.length-1]:null;t&&!t.deps.includes(this)&&(t.deps.push(this),this.subs.push(t))}}class n{constructor(e,n,s){this.vm=e,this.deps=[],this.dep=new t,this.getter=n,this.__value=null,this.dirty=!0,this.cb=s,this.cb&&this.getVal()}get value(){return this.dep.depend(),this.dirty&&this.getVal(),this.__value}getVal(){e.push(this),this.__value=this.getter.call(this.vm),e.pop(),this.dirty=!1}update(){const e=this.value;this.getVal(),this.cb?this.cb.call(this.vm,this.__value,e):this.dirty=!0,this.dep.notify()}}class s{constructor(e){this.value=e,Object.defineProperty(e,"__ob__",{value:this}),Array.isArray(e)?this.observeArray(e):this.observeObj(e)}observeObj(e){Object.keys(e).forEach(n=>{const s=e[n];r(s);const i=function(e,n,s){const r=new t,i=Object.getOwnPropertyDescriptor(e,n);let o=(i.get||(()=>e[n])).call(s);const a=i.set||(e=>{o=e});return Object.defineProperty(e,n,{get:()=>(r.depend(),o),set(t){t!==o&&(a.call(s||e,t),r.notify())},configurable:!0,enumerable:!0}),r}(e,n);Array.isArray(s)&&["push","pop","splice","shift"].forEach(e=>{s[e]=function(...t){const n=Array.prototype[e].apply(s,t);return i.notify(),n}})})}observeArray(e){e.forEach(e=>r(e))}}function r(e){return e&&"object"==typeof e?Object.prototype.hasOwnProperty.call(e,"__ob__")?e.__ob__:new s(e):null}class i{constructor(e,t,n){this.isComponent=!1,this.instanceCreator=null,this.parentNode=null,this.tagName=e,this.props=t||{},this.children=n||[],this.key=t?t.key:void 0,this.isText=!1,this.text="",this.children.forEach((e,t)=>{if(e instanceof i)e.parentNode=this;else{const n=new i;n.isText=!0,n.text=e,n.parentNode=this,this.children[t]=n}})}setComponent(e){return this.isComponent=!0,this.instanceCreator=e,this}render(){if(this.isComponent){null===this.instanceCreator.instance&&(this.instanceCreator.instance=this.instanceCreator.func());const e=this.instanceCreator.instance.$vdom.render();return this.instanceCreator.instance.$el=e,this.instanceCreator.instance.$preVdom.$el=e,this.$el=e,this.instanceCreator.$attrs.style&&(e.style=this.instanceCreator.$attrs.style),e}if(this.isText){const e=document.createTextNode(this.text);return this.$el=e,e}const e=document.createElement(this.tagName);this.$el=e;const{props:t}=this;return Object.keys(t).forEach(e=>{this.setAttr(e,t[e])}),this.children.forEach(t=>{const n=t&&t.render();n&&e.appendChild(n)}),e}setAttr(e,t,n){if("function"==typeof t&&e.startsWith("@")){const s=e.slice(1);n&&this.$el.removeEventListener(s,n),this.$el.addEventListener(s,t)}else"value"===e?this.$el.value=t:t?this.$el.setAttribute(e,t):this.$el.removeAttribute(e)}appendChild(e){this.children.push(e),e.parentNode=this}removeChild(e){const t=this.children.indexOf(e);-1!==t?this.children.splice(t,1):console.log("_Element removeChild failed")}replaceChild(e,t){const n=this.children.indexOf(e);-1!==n?(this.children[n]=t,t.parentNode=this):console.log("_Element replaceChild failed")}removeSelf(){this.parentNode&&this.parentNode.removeChild(this)}replaceSelf(e){this.parentNode&&this.parentNode.replaceChild(this,e)}}const o=new Proxy(i,{apply:(e,t,n)=>new e(...n)});function a(e,t,n=[]){if(e.isComponent&&t.isComponent)return e.instanceCreator.hash!==t.instanceCreator.hash&&n.push({type:"REPLACE",node:e,newNode:t}),n;if(e.isComponent!==t.isComponent)return n.push({type:"REPLACE",node:e,newNode:t}),n;if(e.isText&&t.isText)e.text!==t.text&&n.push({type:"TEXT",node:e,text:t.text});else if(e.tagName===t.tagName){const s=function(e,t){const n=e.props,s=t.props,r={};let i=!0;return Object.keys(n).forEach(e=>{s[e]!==n[e]&&(i=!1,r[e]=[n[e],s[e]])}),Object.keys(s).forEach(e=>{Object.prototype.hasOwnProperty.call(n,e)||(i=!1,r[e]=[null,s[e]])}),i?null:r}(e,t);s&&n.push({node:e,type:"PROPS",props:s}),function(e,t,n,s=[]){const r=Math.max(t.length,n.length);for(let i=0;i<r;i+=1){const r=i<t.length?t[i]:null,o=i<n.length?n[i]:null;r&&o?a(r,o,s):r?s.push({type:"REMOVE",parentNode:e,node:r}):s.push({type:"ADD",parentNode:e,node:o})}}(e,e.children,t.children,n)}else n.push({type:"REPLACE",node:e,newNode:t});return n}function c(e){e&&e.length>0&&e.forEach(e=>{const{type:t,node:n,parentNode:s,newNode:r,text:i}=e;"REPLACE"===t?(n.replaceSelf(r),n.$el.parentNode.replaceChild(r.render(),n.$el)):"PROPS"===t?function(e){const{node:t}=e,{props:n}=e;if(("string"==typeof t||t.isText)&&console.warn("no way here: set props for a textnode"),n){const e=Object.keys(n);e.length>0&&e.forEach(e=>{t.props[e]=n[e][1],t.setAttr(e,n[e][1],n[e][0])})}}(e):"TEXT"===t?(n.text=i,n.$el.nodeValue=i):"ADD"===t?(s.appendChild(n),s.$el.appendChild(n.render())):"REMOVE"===t&&(n.removeSelf(),n.$el.remove())})}function l(e,t,n={}){return void 0!==n[t]?n[t]:e[t]}const h=[];function p(e){return e.startsWith("v-bind:")||e.startsWith(":")||e.startsWith("v-show")}h.push((function(e,t,n,s={}){const r=s&&s.scope||{};if(e.bindGetters||Object.defineProperty(e,"bindGetters",{enumerable:!1,value:{}}),"v-bind"===t){const t=l(this,n,r);return t&&"object"==typeof t&&(Object.assign(e,t),Object.keys(t).forEach(t=>{Object.defineProperty(e.bindGetters,t,{configurable:!0,enumerable:!0,get:()=>l(this,n,r)[t]})})),!0}if(t.startsWith("v-bind:")||t.startsWith(":")){const[,s]=t.split(":");return e[s]=l(this,n,r),Object.defineProperty(e.bindGetters,s,{configurable:!0,enumerable:!0,get:()=>l(this,n,r)}),!0}return!1})),h.push((function(e,t,n){if(t.startsWith("v-on:")||t.startsWith("@")){const[,s]=t.split(/[:@]/);return e["@"+s]=this[n],!0}return!1})),h.push((function(e,t,n){if("v-show"===t){return l(this,n)||(e.style?e.style+=";display:none;":e.style=";display:none;"),!0}return!1})),h.push((function(e,t,n){return e[t]=n,!0}));class u{constructor(e,t={}){this.isRoot=!1,this.name=e,this.attrs=t,this.children=[],this.tPath="root"}addChild(e){this.children.push(e),e.tPath=`${this.tPath}.${e.name}[${this.children.length-1}]`}addAttr(e,t){this.attrs[e]=t}render(e,t){if("v-for"in this.attrs)return function(e,t,n={}){const s=t.trim(),r=s.indexOf(" in "),i=s.substring(0,r).trim();let o=[];i.startsWith("(")?o=i.substr(1,i.length-2).split(",").map(e=>e.trim()):o.push(i);let a=l(e,s.substring(r+4),n)||[],c=!1;return"number"==typeof a?a=Array(a).fill(" ").map((e,t)=>t):"string"==typeof a&&(a=Array(a.length).fill(" ").map((e,t)=>a[t])),Array.isArray(a)?a=a.map((e,t)=>({item:e,index:t,key:t})):"object"==typeof a&&(a=Object.keys(a).map((e,t)=>({item:a[e],index:t,key:e})),c=!0),a.map(({item:e,index:t,key:s})=>{const r={...n};return o.forEach((n,i)=>{switch(i){case 0:r[n]=e;break;case 1:r[n]=c?s:t;break;case 2:c&&(r[n]=t)}}),r})}(e,this.attrs["v-for"],t).map(t=>this.doRender(e,t));if("v-if"in this.attrs){if(!l(e,this.attrs["v-if"]))return null}return this.doRender(e,t)}doRender(e,t={}){if("root"===this.name)return this.children.length?this.children[0].render(e):null;if("text"===this.name)return function(e,t,n={}){let s=t,r=t.match(/{{\w+}}/g);return r=[...new Set(r)],r.forEach(t=>{const r=t.substr(2,t.length-4),i=l(e,r,n);s=s.replace(new RegExp(t.replace(/\{/,"\\{"),"g"),i)}),s}(e,this.attrs.content,t);const n={};Object.keys(this.attrs).filter(e=>!["v-for","v-if"].includes(e)).sort((e,t)=>{const n=p(e)?0:1;return(p(t)?0:1)-n}).forEach(s=>{const r=this.attrs[s];for(const i of h)if(i.call(e,n,s,r,{scope:t}))break});const s=e.component(this.name);if(s){const t={hash:this.tPath,isComponent:!0,createComp:s,$attrs:n.bindGetters,func:()=>s({$parentVm:e,$attrs:n.bindGetters}),instance:null};return o(this.name).setComponent(t)}return o(this.name,n,this.children.map(n=>n.render(e,t)).filter(e=>e).flat())}}function d(e,t,n){const s=t.substr(e).match(n);return s?[s[0],e+s[0].length]:null}function f(e,t,n=null){if(null===n||0===n.length)return[t.substring(e),t.length];let s=e;for(;s<t.length&&!n.includes(t[s]);)s+=1;return s===t.length&&(s=-1),-1===s?[t.substring(e),t.length]:[t.substr(e,s-e),s]}function m(e){try{return function(e){const t=[],n=new u("root",{});if(t.push(n),!e)return n.children;const s=e.trim();let r=0,i=0,o=n;const a={name:"",value:"",separator:"",slash:0};for(;;){if(0===i)if("<"===s[r]&&"/"===s[r+1]){const[,e]=d(r+2,s,/^[^>]+/);r=e+1,t.pop(),o=t[t.length-1]}else if("<"===s[r]){const[e,n]=f(r+1,s,[" ",">"]),a=new u(e);o.addChild(a),t.push(a),o=a,i=" "===s[n]?1:0,r=n+1}else{const[e,t]=f(r,s,["<"]);o.addChild(new u("text",{content:e})),r=t}else if(1===i)if(" "===s[r])r+=1;else if("/"===s[r]&&">"===s[r+1])r+=2,t.pop(),o=t[t.length-1],i=0;else if(">"===s[r])r+=1,i=0;else{const e=d(r,s,/^[^=]+/),[t,n]=e;a.name=t,r=n+1,i=11}else if(11===i){if(!["'",'"'].includes(s[r]))throw new Error("value seperator not valid in "+r);a.separator=s[r],i=111,r+=1}else 111===i&&("\\"===s[r]?(a.slash=1-a.slash,r+=1,a.value+=s[r]):s[r]===a.separator?a.slash?(a.slash=0,r+=1,a.value+=s[r]):(o.addAttr(a.name,a.value),a.name="",a.value="",a.slash=0,a.separator="",i=1,r+=1):(a.value+=s[r],r+=1));if(r>=s.length){if(0!==i)throw new Error("not normal exit state",i);break}}return n}(e)}catch(e){return console.log("err when compile template",e),null}}function y(e){return Array(e.length).fill("").map((t,n)=>{const s=e[n];return s.charCodeAt()>=65&&s.charCodeAt()<=90?`${0!==n?"-":""}${s.toLowerCase()}`:s}).join("")}var b={create:function(e,t){const n={};return function(s,r){const i=y(s);if(!r)return t&&t(i)||n[i];n[i]=function(t){const n={...r,...t};return new e(n)},n[i].options=r}},normalizeName:y};function g(e,t,n){Object.defineProperty(e,t,{configurable:!0,enumerable:!0,...n})}function v(e,t){Object.keys(e).forEach(n=>{g(t,n,{set:function(t){e[n]=t},get:function(){return e[n]}})})}function $(e){const t=this;t.$options=e,e.el&&("string"==typeof e.el?t.$el=document.querySelector(e.el):t.$el=e.el),t.isRoot=!!e.el,t.component=t.isRoot?$.component:b.create($,$.component);const s=e.components||{};if(Object.keys(s).forEach(e=>t.component(e,s[e])),e.$parentVm){t.$parentVm=e.$parentVm;let s=e.props||{};if(Array.isArray(s)){const e={};s.forEach(t=>{e[t]={}}),s=e}const r={};Object.keys(s).forEach(s=>{const i=new n(t,()=>e.$attrs[s]);g(r,s,{get:function(){return i.value},set:function(e){console.warn("cannot set prop value with",e)}})}),v(r,t)}let i=e.data||{};i="function"==typeof e.data?e.data.call(t):i,r(i),t.$data=i,v(i,t);const o=e.computed||{},l={};Object.keys(o).forEach(e=>{const s=o[e],r=new n(t,s);g(l,e,{get:function(){return r.value},set:function(e){console.warn("cannot set computed value with",e)}})}),v(l,t);const h=e.methods||{};Object.keys(h).forEach(e=>{const n=h[e];t[e]=(...e)=>n.apply(t,e)});const p=e.watch||{};t.$watchers=[],Object.keys(p).forEach(e=>{const s=p[e],r=new n(t,()=>{let n=t;return e.split(".").forEach(e=>{n=n[e]}),n},(...e)=>s.apply(t,e));t.$watchers.push(r)}),t.$elTree=m(e.template||""),t.$elTree.isComponent=!!t.$parentVm,t.$render=()=>t.$elTree.render(t),t.render=()=>{if(t.$render)if(t.$vdom=t.$render.call(t),t.$preVdom){c(a(t.$preVdom,t.$vdom))}else t.isRoot&&(t.$el.firstElementChild&&t.$el.firstElementChild.remove(),t.$el.appendChild(t.$vdom.render())),t.$preVdom=t.$vdom},t.renderWatcher=new n(t,t.render),t.render()}return $.component=b.create($),$}));
